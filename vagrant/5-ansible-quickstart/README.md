# Multi-VM Vagrant Setup with Ansible Provisioning

This tutorial guides you through setting up multiple Ubuntu 22.04 LTS virtual machines with Vagrant, and provisioning them using Ansible. You'll customize a Vagrantfile, start the VMs, SSH into them, and finally, destroy the allocated resources.

## Objective

By the end of this tutorial, you will have:
- Configured multiple VMs in a private network.
- Used Ansible to provision these VMs automatically.

## Prerequisites

- A basic understanding of virtualization, networking, and automation concepts.
- Vagrant installed on your system. Download it from [Vagrant's official website](https://www.vagrantup.com/downloads).
- VirtualBox installed as your hypervisor. Download it from [VirtualBox's official website](https://www.virtualbox.org/wiki/Downloads).
- Ansible installed on your system for provisioning. Installation guides are available on [Ansible's official documentation](https://docs.ansible.com/ansible/latest/installation_guide/index.html).
- Familiarity with terminal or command prompt commands.

## Step 1: Prepare Your Project Directory

1. Open a terminal or command prompt.
2. Create a new directory for your Vagrant project and change into it:
   ```bash
   mkdir vagrant-ansible-quickstart
   cd vagrant-ansible-quickstart
   ```
3. This directory will contain your Vagrantfile and Ansible playbook.

## Step 2: Initialize Your Vagrant Environment

1. While in your project directory, initialize a new Vagrant environment by generating a `Vagrantfile`:
   ```bash
   vagrant init
   ```
2. This command creates a `Vagrantfile` with default content. You'll replace this with your custom configuration.

## Step 3: Customize the Vagrantfile

1. Open the `Vagrantfile` in a text editor of your choice.
2. Replace the content with the provided configuration to define two Ubuntu 22.04 LTS VMs and the Ansible provisioning settings:
   ```ruby
   # -*- mode: ruby -*-
   # vi: set ft=ruby :

   VAGRANTFILE_API_VERSION = "2"

   Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
     config.vm.box = "bento/ubuntu-22.04"

     config.vm.define "vm1" do |vm1|
       vm1.vm.hostname = "vm1"
       vm1.vm.network "private_network", ip: "192.168.56.10"
     end

     config.vm.define "vm2" do |vm2|
       vm2.vm.hostname = "vm2"
       vm2.vm.network "private_network", ip: "192.168.56.11"
     end

     config.vm.provision "ansible" do |ansible|
       ansible.playbook = "playbook.yml"
     end
   end
   ```
3. Save and close the `Vagrantfile`.

## Step 4: Create an Ansible Playbook

1. Create a file named `playbook.yml` in the same directory as your `Vagrantfile`.
2. Define the tasks you want Ansible to execute on your VMs. For simplicity, this could be a simple ping task to ensure connectivity. See below:
    ```yml
    ---
    - hosts: all
    tasks:
    - name: Ping Hosts
        ansible.builtin.ping:

    - name: Print Message
        ansible.builtin.debug:
        msg: "Hello World!"

    ```

    This playbook targets `all` hosts and performs tasks like `ansible.builtin.ping` and `ansible.builtin.debug`. The `ping` task allows you to test connectivity and `debug` is useful for printing messages or variables to your output. 

    To obtain a detailed inventory of what hosts are being targeted (`all` in this case) targets, you can check the `.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory` file. This file is automatically generated by Vagrant and looks like:
    ```ini
    # Generated by Vagrant

    vm2 ansible_ssh_host=127.0.0.1 ansible_ssh_port=2200 ansible_ssh_user='vagrant' ansible_ssh_private_key_file='/path/to/.vagrant/machines/vm2/virtualbox/private_key'
    
    vm1 ansible_ssh_host=127.0.0.1 ansible_ssh_port=2222 ansible_ssh_user='vagrant' ansible_ssh_private_key_file='/path/to/.vagrant/machines/vm1/virtualbox/private_key'

    ```

## Step 5: Launch and Provision the VMs

1. Start the VMs and provision them using Ansible by running:
   ```bash
   vagrant up
   ```
2. Vagrant will read the `Vagrantfile`, download the Ubuntu box (if necessary), create both VMs, configure their network settings, and run the Ansible playbook specified.

3. If you forgot to install Ansible, you will get a message like the one below:
    ```txt
    Vagrant gathered an unknown Ansible version:
    and falls back on the compatibility mode '1.8'.
    
    Alternatively, the compatibility mode can be specified in your Vagrantfile:
    https://www.vagrantup.com/docs/provisioning/ansible_common.html#compatibility_mode
    
          vm1: Running ansible-playbook...
    
    The Ansible software could not be found! Please verify
    that Ansible is correctly installed on your host system.
    
    If you haven't installed Ansible yet, please install Ansible
    on your host system. Vagrant can't do this for you in a safe and
    automated way.
    
    Please check https://docs.ansible.com for more information.
    ```
4. If everything went right, during the provisioning process you will see the `ping` being executed and the message `Hello World` being printed. At the end, you will get a play recap notifying what went right, what changed, and what failed or got skipped.
5. If you update the `playbook.yml` and want to re-provision the VMs, you can run:
    ```bash
    vagrant provision
    ```


## Step 6: Verify and Connect

1. Ensure the VMs are running and reachable:
   ```bash
   vagrant status
   ```
2. SSH into either VM to inspect or modify its configuration:
   ```bash
   vagrant ssh vm1
   ```
3. To exit the SSH session, type:
   ```bash
   exit
   ```

## Step 7: Clean Up Resources

1. When you're finished, you can stop and delete the VMs to free up resources:
   ```bash
   vagrant destroy -f
   ```
2. Confirm that the VMs have been removed with `vagrant status`.

## Conclusion

You have now created a Vagrant environment with multiple Ubuntu 22.04 LTS VMs, configured to communicate on a private network, and provisioned automatically with Ansible.
